#!/bin/sh

MSG_FILE="$1"
# Nur die erste Zeile der Commit-Message prüfen
MSG="$(head -n 1 "$MSG_FILE")"
BRANCH="$(git rev-parse --abbrev-ref HEAD)"

case "$BRANCH" in
  release/*)
    # ERLAUBT:
    #   release/X.Y.Z
    #   release/X.Y.Z-rcN
    if echo "$BRANCH" | grep -Eq '^release/[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$'; then
      # keine Issue-Pflicht auf Versions-Branches
      exit 0
    else
      echo "❌ Commit abgebrochen."
      echo "    Release-Branch muss so aussehen:"
      echo "      - release/X.Y.Z"
      echo "      - release/X.Y.Z-rcN"
      echo "    Beispiel: release/3.0.0 oder release/3.0.0-rc1"
      exit 1
    fi
    ;;

  feature/*|bugfix/*|hotfix/*|docs/*)
    # Branch-Schema: typ/<nummer>-beschreibung
    if echo "$BRANCH" | grep -Eq '^(feature|bugfix|hotfix|docs)/[0-9]+-'; then
      ISSUE_NUM="$(echo "$BRANCH" | sed -E 's@^[^/]+/([0-9]+)-.*@\1@')"

      # Prüfen, ob in der ERSTEN ZEILE "#<ISSUE_NUM>" vorkommt
      if ! echo "$MSG" | grep -q "#$ISSUE_NUM"; then
        echo "❌ Commit abgebrochen."
        echo "    Branch: $BRANCH  → erwartete Issue-Nummer: #$ISSUE_NUM"
        echo "    Die erste Zeile der Commit-Message muss die Issue-Nummer enthalten."
        echo "    Beispiel: \"Ordnerstruktur angepasst (#$ISSUE_NUM)\""
        exit 1
      fi
    else
      echo "❌ Commit abgebrochen."
      echo "    Branch-Name entspricht nicht dem Schema:"
      echo "    Erwarte z.B.:"
      echo "      feature/2-beschreibung"
      echo "      bugfix/5-irgendwas"
      echo "      docs/7-doku-anpassen"
      exit 1
    fi
    ;;

  *)
    # alle anderen Branches sperren
    echo "❌ Commit abgebrochen."
    echo "    Auf Branch '$BRANCH' sind direkte Commits nicht erlaubt."
    echo "    Erlaubte Branches:"
    echo "      - feature/<nummer>-beschreibung"
    echo "      - bugfix/<nummer>-beschreibung"
    echo "      - hotfix/<nummer>-beschreibung"
    echo "      - docs/<nummer>-beschreibung"
    echo "      - release/X.Y.Z"
    echo "      - release/X.Y.Z-rcN"
    exit 1
    ;;
esac

exit 0
