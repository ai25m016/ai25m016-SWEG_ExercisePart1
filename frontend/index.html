<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Simple Social</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; background: #f5f5f5; }
    h1 { margin-bottom: 1rem; }
    section { background:#fff; padding:1rem 1.5rem; margin-bottom:1.5rem; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
    label { display:block; margin:0.5rem 0 0.2rem; font-weight:600; }
    input[type="text"], textarea { width:100%; padding:0.4rem 0.6rem; border-radius:4px; border:1px solid #ccc; box-sizing:border-box; }
    textarea { min-height:80px; }
    button { margin-top:0.6rem; padding:0.5rem 1rem; border-radius:4px; border:none; cursor:pointer; background:#2563eb; color:white; font-weight:600; }
    button.secondary { background:#4b5563; }
    button.small { padding:0.35rem 0.7rem; font-size:0.9rem; }
    #status { margin-top:0.5rem; font-size:0.9rem; }
    .status-ok { color:#16a34a; }
    .status-error { color:#dc2626; }
    .posts { display:flex; flex-direction:column; gap:0.75rem; }
    .post { border:1px solid #e5e7eb; padding:0.75rem; border-radius:6px; background:#f9fafb; }
    .post-header { display:flex; justify-content:space-between; font-size:0.9rem; margin-bottom:0.4rem; gap:1rem; }
    .post-user { font-weight:700; }
    .post-image { max-width:150px; max-height:150px; display:block; margin-top:0.4rem; border-radius:4px; object-fit:cover; }
    .filters { display:flex; gap:0.5rem; align-items:center; margin-top:0.5rem; flex-wrap:wrap; }
    .filters input { max-width:200px; }

    .suggest-box {
      margin-top: 0.6rem;
      padding: 0.6rem;
      border-radius: 6px;
      background: #eef2ff;
      border: 1px solid #c7d2fe;
      font-size: 0.95rem;
      display: none;
    }
    .suggest-actions { display:flex; gap:0.5rem; margin-top:0.5rem; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>Simple Social</h1>

  <section>
    <h2>Post erstellen</h2>
    <form id="post-form" enctype="multipart/form-data">
      <label for="image">Bild</label>
      <input type="file" id="image" name="image" accept="image/*" required />

      <label for="text">Text</label>
      <textarea id="text" name="text" placeholder="Schreibe etwas..." required></textarea>

      <div class="suggest-actions">
        <button type="button" id="btn-suggest" class="secondary small">Kommentar vorschlagen</button>
        <button type="button" id="btn-apply" class="secondary small" disabled>Ãœbernehmen</button>
        <button type="button" id="btn-clear-suggest" class="secondary small" disabled>Vorschlag verwerfen</button>
      </div>

      <div id="suggest-box" class="suggest-box"></div>

      <label for="user">User</label>
      <input type="text" id="user" name="user" placeholder="alice" value="alice" required />

      <button type="submit">Post erstellen</button>
    </form>
    <div id="status"></div>
  </section>

  <section>
    <h2>Posts</h2>

    <div class="filters">
      <button id="reload-posts" class="secondary">Alle neu laden</button>
      <span>Filter by user:</span>
      <input type="text" id="filter-user" placeholder="alice" />
      <button id="filter-button">Search</button>
      <button id="clear-filter" class="secondary">Clear</button>
    </div>

    <div id="posts-container" class="posts" style="margin-top: 1rem;"></div>
  </section>

  <script>
    // Muss vom Browser erreichbar sein (nicht "http://backend:8000"!)
    const API_BASE = "http://127.0.0.1:8000";

    const form = document.getElementById("post-form");
    const statusDiv = document.getElementById("status");
    const postsContainer = document.getElementById("posts-container");
    const reloadButton = document.getElementById("reload-posts");
    const filterInput = document.getElementById("filter-user");
    const filterButton = document.getElementById("filter-button");
    const clearFilterButton = document.getElementById("clear-filter");

    const textEl = document.getElementById("text");
    const btnSuggest = document.getElementById("btn-suggest");
    const btnApply = document.getElementById("btn-apply");
    const btnClearSuggest = document.getElementById("btn-clear-suggest");
    const suggestBox = document.getElementById("suggest-box");

    let currentJobId = null;
    let currentSuggestion = "";

    function setStatus(message, ok = true) {
      statusDiv.textContent = message;
      statusDiv.className = ok ? "status-ok" : "status-error";
    }

    function showSuggestion(msg, isError = false) {
      suggestBox.style.display = "block";
      suggestBox.style.borderColor = isError ? "#fecaca" : "#c7d2fe";
      suggestBox.style.background = isError ? "#fef2f2" : "#eef2ff";
      suggestBox.textContent = msg;
    }

    function clearSuggestionUI() {
      currentJobId = null;
      currentSuggestion = "";
      suggestBox.style.display = "none";
      suggestBox.textContent = "";
      btnApply.disabled = true;
      btnClearSuggest.disabled = true;
      btnSuggest.disabled = false;
    }

    async function pollJob(jobId, maxTries = 20, intervalMs = 700) {
      for (let i = 0; i < maxTries; i++) {
        await new Promise(r => setTimeout(r, intervalMs));

        const res = await fetch(`${API_BASE}/textgen/jobs/${jobId}`);
        if (!res.ok) continue;

        const job = await res.json();
        if (job.status === "done") {
          currentSuggestion = job.generated_text || "";
          showSuggestion("ðŸ’¡ Vorschlag: " + currentSuggestion, false);
          btnApply.disabled = !currentSuggestion;
          btnClearSuggest.disabled = false;
          btnSuggest.disabled = false;
          return;
        }
        if (job.status === "error") {
          showSuggestion("âš ï¸ Fehler: " + (job.error || "unknown"), true);
          btnClearSuggest.disabled = false;
          btnSuggest.disabled = false;
          return;
        }

        showSuggestion("ðŸ¤– Generiere Kommentarâ€¦", false);
      }

      showSuggestion("âš ï¸ Timeout: Textgenerierung dauert zu lange.", true);
      btnClearSuggest.disabled = false;
      btnSuggest.disabled = false;
    }

    btnSuggest.addEventListener("click", async () => {
      const prompt = (textEl.value || "").trim();
      if (!prompt) {
        setStatus("Bitte erst Text eingeben.", false);
        return;
      }

      btnSuggest.disabled = true;
      btnApply.disabled = true;
      btnClearSuggest.disabled = true;
      showSuggestion("ðŸ¤– Generiere Kommentarâ€¦", false);

      try {
        const res = await fetch(`${API_BASE}/textgen/jobs`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ prompt, max_new_tokens: 60 })
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || "TextGen Job konnte nicht gestartet werden");
        }

        const job = await res.json();
        currentJobId = job.id;
        await pollJob(currentJobId);

      } catch (e) {
        console.error(e);
        showSuggestion("âš ï¸ Fehler: " + e.message, true);
        btnSuggest.disabled = false;
        btnClearSuggest.disabled = false;
      }
    });

    btnApply.addEventListener("click", () => {
      if (!currentSuggestion) return;
      textEl.value = currentSuggestion;
      setStatus("Vorschlag Ã¼bernommen âœ…", true);
      clearSuggestionUI();
    });

    btnClearSuggest.addEventListener("click", () => {
      clearSuggestionUI();
      setStatus("Vorschlag verworfen.", true);
    });

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    async function waitForThumb(postId, onReady, maxTries = 30, intervalMs = 700) {
      for (let i = 0; i < maxTries; i++) {
        await sleep(intervalMs);

        try {
          const res = await fetch(`${API_BASE}/posts/${postId}`);
          if (!res.ok) continue;
          const fresh = await res.json();
          if (fresh.image_small) {
            onReady(fresh);
            return;
          }
        } catch (_) {
          // ignore
        }
      }
    }

    function renderPosts(posts) {
      postsContainer.innerHTML = "";
      if (!Array.isArray(posts) || posts.length === 0) {
        postsContainer.innerHTML = "<p>Keine Posts gefunden.</p>";
        return;
      }

      const base = API_BASE.replace(/\/+$/, "");
      const toUrl = (p) => {
        if (!p) return "";
        return base + (p.startsWith("/") ? p : "/" + p);
      };

      posts.forEach((post) => {
        const div = document.createElement("div");
        div.className = "post";

        const origUrl = post.image ? toUrl(post.image) : "";
        const thumbUrl = post.image_small ? toUrl(post.image_small) : "";

        // --- Header: links User, rechts Thumb-Pfad ---
        const header = document.createElement("div");
        header.className = "post-header";

        const userSpan = document.createElement("span");
        userSpan.className = "post-user";
        userSpan.textContent = post.user ?? "unknown";

        const rightSpan = document.createElement("span");

        // Rechts nur der Thumbnail-Pfad (klickbar, Ã¶ffnet Thumb-Datei)
        const thumbPathLink = document.createElement("a");
        thumbPathLink.href = thumbUrl || "#";
        thumbPathLink.target = "_blank";
        thumbPathLink.rel = "noopener";
        thumbPathLink.textContent = (post.image_small || "").trim() || "(kein Thumbnail yet)";
        rightSpan.appendChild(thumbPathLink);

        header.appendChild(userSpan);
        header.appendChild(rightSpan);
        div.appendChild(header);

        // --- Text ---
        const textP = document.createElement("p");
        textP.textContent = post.text ?? "";
        div.appendChild(textP);

        // --- Bild: Thumbnail anzeigen, Klick -> Original ---
        if (origUrl || thumbUrl) {
          const img = document.createElement("img");
          img.className = "post-image";

          // solange thumb fehlt -> original anzeigen (fallback)
          img.src = thumbUrl || origUrl;
          img.alt = "post image";

          // Klick auf Bild Ã¶ffnet immer Original
          const a = document.createElement("a");
          a.href = origUrl || thumbUrl; // falls original aus irgendeinem Grund fehlt
          a.target = "_blank";
          a.rel = "noopener";
          a.appendChild(img);

          div.appendChild(a);

          // Wenn Thumbnail noch nicht da: hint + automatisch updaten
          if (!post.image_small && post.id != null) {
            img.style.opacity = "0.7";

            const hint = document.createElement("div");
            hint.style.fontSize = "0.85rem";
            hint.style.marginTop = "0.25rem";
            hint.textContent = "Thumbnail wird erstelltâ€¦";
            div.appendChild(hint);

            waitForThumb(post.id, (fresh) => {
              const newThumbUrl = toUrl(fresh.image_small);
              if (!newThumbUrl) return;

              // Thumb anzeigen (cache-buster)
              img.src = newThumbUrl + `?t=${Date.now()}`;
              img.style.opacity = "1.0";

              // Rechts oben den Thumb-Pfad aktualisieren
              thumbPathLink.href = newThumbUrl;
              thumbPathLink.textContent = fresh.image_small;

              hint.textContent = "Thumbnail fertig âœ…";
            });
          }
        }

        postsContainer.appendChild(div);
      });
    }


    async function loadPosts(userFilter = null) {
      try {
        const url = userFilter
          ? `${API_BASE}/posts?user=${encodeURIComponent(userFilter)}`
          : `${API_BASE}/posts`;

        const res = await fetch(url);
        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || "Posts konnten nicht geladen werden");
        }

        const posts = await res.json();
        renderPosts(posts);
      } catch (e) {
        console.error(e);
        setStatus("Fehler beim Laden der Posts (Console checken).", false);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const fd = new FormData(form);

      try {
        const res = await fetch(`${API_BASE}/posts`, {
          method: "POST",
          body: fd,
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || "Post konnte nicht erstellt werden");
        }

        setStatus("Post erstellt âœ…", true);

        // Optional: Text/Bild leeren, User behalten
        const userVal = document.getElementById("user").value;
        form.reset();
        document.getElementById("user").value = userVal;

        clearSuggestionUI();

        // Posts neu laden (Thumbnail updated automatisch via waitForThumb)
        const currentFilter = (filterInput.value || "").trim();
        await loadPosts(currentFilter || null);

      } catch (e2) {
        console.error(e2);
        setStatus("Fehler: " + e2.message, false);
      }
    });

    reloadButton.addEventListener("click", (e) => {
      e.preventDefault();
      const currentFilter = (filterInput.value || "").trim();
      loadPosts(currentFilter || null);
    });

    filterButton.addEventListener("click", (e) => {
      e.preventDefault();
      const u = (filterInput.value || "").trim();
      loadPosts(u || null);
    });

    clearFilterButton.addEventListener("click", (e) => {
      e.preventDefault();
      filterInput.value = "";
      loadPosts(null);
    });

    // initial load
    loadPosts(null);
  </script>
</body>
</html>
