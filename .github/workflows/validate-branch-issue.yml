name: validate-branch-and-issue

on:
  push:
    branches:
      - '**'          # bei jedem Push prüfen
  pull_request:
    branches:
      - main
      - develop       # bei PRs zusätzlich (für Branch-Protection)

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      # "before" für Push-Events ins Environment holen
      GITHUB_EVENT_BEFORE: ${{ github.event.before }}

    steps:
      - name: Show branch info
        run: |
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Ref:   $GITHUB_REF"
          echo "Base:  $GITHUB_BASE_REF"
          echo "Head:  $GITHUB_HEAD_REF"

      - name: Check branch name pattern
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          echo "Checking branch name: $BRANCH"

          # Erlaubte Branch-Typen: feature/NUM-..., bugfix/NUM-..., hotfix/NUM-..., release/NUM-...
          if echo "$BRANCH" | grep -Eq '^(feature|bugfix|hotfix|release)/[0-9]+-'; then
            echo "✅ Branch name is valid."
          else
            echo "❌ Invalid branch name."
            echo "   Expected: feature/2-something, bugfix/3-other, hotfix/10-..., release/1-0-0-..."
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Check commit messages contain issue number
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # Issue-Nummer aus Branch holen, z.B. feature/2-xyz -> 2
          ISSUE_NUM="$(echo "$BRANCH" | sed -E 's@^[^/]+/([0-9]+)-.*@\1@')"
          echo "Expected issue number: #$ISSUE_NUM"

          # Commit-Range bestimmen
          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            # nur die neuen Commits dieses Pushes
            RANGE="$GITHUB_EVENT_BEFORE..$GITHUB_SHA"
          else
            # PR: alle Commits zwischen Base-Branch und HEAD
            git fetch origin "$GITHUB_BASE_REF" --depth=1
            RANGE="origin/$GITHUB_BASE_REF..HEAD"
          fi

          echo "Using range: $RANGE"
          COMMITS="$(git log --format='%s' $RANGE || true)"

          if [ -z "$COMMITS" ]; then
            echo "ℹ️ No commits found in range (nothing to check)."
            exit 0
          fi

          echo "Commit messages in this range:"
          echo "$COMMITS"
          echo

          # Prüfen, ob ALLE neuen Commits #ISSUE_NUM enthalten
          MISSING=$(echo "$COMMITS" | grep -v "#$ISSUE_NUM" || true)

          if [ -n "$MISSING" ]; then
            echo "❌ Some commit messages are missing #$ISSUE_NUM:"
            echo "$MISSING"
            echo
            echo "   Please include '#$ISSUE_NUM' in every new commit message on this branch."
            exit 1
          fi

          echo "✅ All commit messages contain #$ISSUE_NUM."
