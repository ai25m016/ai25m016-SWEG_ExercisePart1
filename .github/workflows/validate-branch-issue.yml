name: validate-branch-and-issue

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Show branch info
        run: |
          echo "Event:       $GITHUB_EVENT_NAME"
          echo "Ref:         $GITHUB_REF"
          echo "Base (PR):   $GITHUB_BASE_REF"
          echo "Head (PR):   $GITHUB_HEAD_REF"
          echo "Ref name:    $GITHUB_REF_NAME"

      - name: Check branch name pattern
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          echo "Checking branch name: $BRANCH"

          # main und develop explizit erlauben
          if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "develop" ]; then
            echo "✅ Branch '$BRANCH' is allowed (main/develop)."
            exit 0
          fi

          # Release-Branches NUR als:
          #   release/X.Y.Z
          #   release/X.Y.Z-rcN
          if echo "$BRANCH" | grep -Eq '^release/[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$'; then
            echo "✅ Release branch with semantic version: $BRANCH"
            exit 0
          fi

          # Erlaubte Branch-Typen mit Issue-Nummer:
          #   feature/NUM-...
          #   bugfix/NUM-...
          #   hotfix/NUM-...
          #   docs/NUM-...
          if echo "$BRANCH" | grep -Eq '^(feature|bugfix|hotfix|docs)/[0-9]+-'; then
            echo "✅ Branch name with issue number is valid."
            exit 0
          fi

          echo "❌ Invalid branch name: $BRANCH"
          echo "   Expected one of:"
          echo "     main"
          echo "     develop"
          echo "     release/X.Y.Z (z.B. release/3.0.0)"
          echo "     release/X.Y.Z-rcN (z.B. release/3.0.0-rc1)"
          echo "     feature/<nummer>-beschreibung  (z.B. feature/12-login-page)"
          echo "     bugfix/<nummer>-beschreibung   (z.B. bugfix/7-fix-crash)"
          echo "     hotfix/<nummer>-beschreibung   (z.B. hotfix/3-prod-bug)"
          echo "     docs/<nummer>-beschreibung     (z.B. docs/5-update-readme)"
          exit 1

      - uses: actions/checkout@v4

      # ✅ Commit-Messages NUR bei Push prüfen, NICHT beim PR-Event
      - name: Check commit messages contain issue number (only on push)
        if: ${{ github.event_name == 'push' }}
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          echo "Current branch: $BRANCH"

          # Für main/develop keine Issue-Pflicht
          if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "develop" ]; then
            echo "ℹ️ Branch '$BRANCH' has no issue number convention. Skipping commit message check."
            exit 0
          fi

          # Für Release-Branches (release/X.Y.Z oder release/X.Y.Z-rcN) ebenfalls keine Issue-Pflicht
          if echo "$BRANCH" | grep -Eq '^release/[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$'; then
            echo "ℹ️ Release branch '$BRANCH' has no commit issue requirement. Skipping commit message check."
            exit 0
          fi

          # Issue-Nummer aus Branch holen, z.B. feature/2-xyz -> 2
          ISSUE_NUM="$(echo "$BRANCH" | sed -En 's@^[^/]+/([0-9]+)-.*@\1@p')"

          if [ -z "$ISSUE_NUM" ]; then
            echo "ℹ️ No issue number could be extracted from branch name '$BRANCH'."
            echo "   Skipping commit message check."
            exit 0
          fi

          echo "Expected issue number: #$ISSUE_NUM"
          echo

          BEFORE="${{ github.event.before }}"
          SHA="$GITHUB_SHA"

          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            RANGE="$SHA^..$SHA"
          else
            RANGE="$BEFORE..$SHA"
          fi

          echo "Checking commits in push range: $RANGE"
          echo

          COMMITS="$(git log --format='%s' $RANGE || true)"

          if [ -z "$COMMITS" ]; then
            echo "ℹ️ No commits found in range (nothing to check)."
            exit 0
          fi

          echo "Commit messages in range:"
          echo "$COMMITS"
          echo

          echo "$COMMITS" | grep "#$ISSUE_NUM" > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "❌ No commit message in this push contains #$ISSUE_NUM."
            echo "   Please include the issue number in your commit message,"
            echo "   e.g. \"Something useful (#$ISSUE_NUM)\"."
            exit 1
          fi

          echo "✅ At least one commit message from this push contains #$ISSUE_NUM."
