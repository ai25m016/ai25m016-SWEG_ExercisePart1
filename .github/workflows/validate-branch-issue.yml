name: validate-branch-and-issue

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Show branch info
        run: |
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Ref:   $GITHUB_REF"
          echo "Base:  $GITHUB_BASE_REF"
          echo "Head:  $GITHUB_HEAD_REF"

      - name: Check branch name pattern
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          echo "Checking branch name: $BRANCH"

          # Erlaubte Branch-Typen: feature/NUM-..., bugfix/NUM-..., hotfix/NUM-..., release/NUM-...
          if echo "$BRANCH" | grep -Eq '^(feature|bugfix|hotfix|release)/[0-9]+-'; then
            echo "✅ Branch name is valid."
          else
            echo "❌ Invalid branch name."
            echo "   Expected: feature/2-something, bugfix/3-other, hotfix/10-..., release/1-0-0-..."
            exit 1
          fi

      - uses: actions/checkout@v4

      - name: Check LAST non-merge commit contains issue number
        run: |
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          # Issue number from branch name
          ISSUE_NUM="$(echo "$BRANCH" | sed -E 's@^[^/]+/([0-9]+)-.*@\1@')"
          echo "Expected issue number: #$ISSUE_NUM"

          # Find last NON-MERGE commit (no parents count 2)
          LAST_REAL_COMMIT="$(git log --no-merges -1 --format='%H')"
          LAST_MSG="$(git log -1 --format='%s' "$LAST_REAL_COMMIT")"

          echo "Last NON-MERGE commit message:"
          echo "$LAST_MSG"
          echo

          echo "$LAST_MSG" | grep "#$ISSUE_NUM" > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "❌ Commit message does NOT contain #$ISSUE_NUM."
            exit 1
          fi

          echo "✅ Non-merge commit contains #$ISSUE_NUM."
